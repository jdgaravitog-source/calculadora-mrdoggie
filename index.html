<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Mr. Doggie v4.0</title>
    <meta name="description"
        content="Calculadora nutricional para perros y gatos. Descubre la porción ideal para tu mascota con Mr. Doggie.">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;900&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        /* ============================================
           1. VARIABLES Y RESET
           ============================================ */
        :root {
            --black: #000000;
            --dark-gray: #121212;
            --medium-gray: #333333;
            --white: #FFFFFF;
            --red: #D30101;
            --hover-red: #A30000;
            --green-product: #388E3C;
            --orange-product: #F57C00;
            --blue-product: #1976D2;
            --gold: #FFD700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* BODY STYLES MERGED WITH MAIN DEFINITION BELOW */

        /* ============================================
           2. LAYOUT PRINCIPAL Y EFECTOS
           ============================================ */
        /* FRESHNESS GLOWS */
        .fresh-glow {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.15;
            pointer-events: none;
        }

        .glow-1 {
            background: var(--green-product);
            top: -200px;
            left: -200px;
        }

        .glow-2 {
            background: var(--orange-product);
            bottom: -200px;
            right: -200px;
        }


        /* Container & Wizard Layout */
        .calculator-container {
            width: 100%;
            max-width: 700px;
            height: 100vh;
            max-height: 900px;
            background: var(--dark-gray);
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            margin: 0 auto;
            /* Force center horizontally */
        }

        @media (min-width: 768px) {
            .calculator-container {
                height: 95vh;
                border-radius: 20px;
                border: 1px solid #333;
            }
        }

        /* Sticky Action Bar */
        .nav-actions {
            /* Integrated Flow Layout */
            position: relative;
            margin-top: auto;
            width: 100%;
            max-width: 550px;
            /* Constrain width to keep buttons closer */
            margin-left: auto;
            margin-right: auto;
            padding: 30px 0;
            /* Vertical padding only, let max-width handle horizontal spacing */
            background: transparent;
            backdrop-filter: none;
            border-top: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        /* Mobile Optimization for Navigation */
        @media (max-width: 768px) {
            .nav-actions {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 10px 15px !important;
                /* Reduced padding */
                background: #121212 !important;
                border-top: 1px solid #333;
                z-index: 99999 !important;
                box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.8);
                gap: 10px;
                /* Reduced gap */
            }

            .wizard-header img.brand-logo {
                height: 70px !important;
                /* Smaller logo to gain space */
            }

            .slide h2 {
                font-size: 18px !important;
                margin-top: 0 !important;
                margin-bottom: 10px !important;
            }

            /* Ensure content isn't hidden behind fixed nav */
            .slide {
                padding-bottom: 90px !important;
                padding-top: 10px !important;
                /* Move up */
            }

            /* User requested smaller icons on mobile to avoid cramped layout */
            .big-option img {
                height: 32px !important;
                /* Even smaller */
                width: auto !important;
                margin-bottom: 3px !important;
            }

            .big-option {
                padding: 8px 5px !important;
                min-height: 80px !important;
            }

            .opt-label {
                font-size: 8px !important;
            }

            /* REFINED: Dynamic tooltips on mobile (Hidden default, Show on Hover/Selected) */
            /* Default: Hidden */
            html body .compact-opt .hover-tip {
                display: block !important;
                /* Ensure layout allows it when visible */
                opacity: 0 !important;
                max-height: 0 !important;
                margin-top: 0 !important;
                overflow: hidden !important;
                visibility: hidden !important;
                transition: all 0.3s ease !important;
            }

            /* Interaction: Visible on Hover (touch press) or Selected */
            html body .compact-opt:hover .hover-tip,
            html body .compact-opt.selected .hover-tip {
                opacity: 1 !important;
                max-height: 50px !important;
                margin-top: 4px !important;
                visibility: visible !important;
            }

            /* Make buttons more compact to declutter footer */
            .btn-nav-next {
                padding: 10px 20px !important;
                font-size: 13px !important;
                width: 100%;
                justify-content: center;
            }

            .btn-nav-back {
                padding: 10px 15px !important;
                font-size: 13px !important;
                background: rgba(255, 255, 255, 0.05) !important;
            }

            #btnQuickFinish {
                padding: 10px 12px !important;
                font-size: 10px !important;
            }

            .calculator-container {
                height: 100% !important;
                max-height: none !important;
            }
        }


        /* Hide nav actions on step 0 (intro) and last step (results) if desired, 
           or handle visibility via JS. We'll handle via JS class 'hidden' */
        /* Proper hiding for relative nav */
        .nav-actions.hidden {
            display: none !important;
        }

        .btn-nav-back {
            background: transparent;
            color: #888;
            border: 2px solid transparent;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-nav-back:hover {
            color: var(--white);
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-nav-next {
            background: var(--red);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 12px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-nav-next:hover {
            background: var(--hover-red);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.6);
        }

        .btn-nav-next:disabled {
            background: #333;
            color: #555;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }

        /* HERO REDESIGN v4.1 */
        .hero-img-container {
            margin-bottom: 20px;
            /* Animation removed as requested */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .hero-img-container img {
            mix-blend-mode: lighten;
            object-fit: contain;
            filter: contrast(1.1) brightness(1.2) drop-shadow(0 20px 50px rgba(0, 0, 0, 0.5));
            transform: scale(1.05);
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 950;
            /* Ultra bold */
            font-size: 38px;
            line-height: 1.05;
            margin-bottom: 40px;
            /* More air */
            background: linear-gradient(to bottom, #fff 40%, #888 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            letter-spacing: -1.5px;
        }

        /* Modern "Statement" Button - Refined v4.2 */
        .hero-btn {
            background: linear-gradient(135deg, var(--red) 0%, #a01515 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 850;
            font-size: 15px;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(211, 47, 47, 0.35);
            transition: all 0.4s cubic-bezier(0.2, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            width: auto;
            min-width: 280px;
            text-transform: uppercase;
            margin-top: 35px;
            /* More air a&ntilde;ove */
        }

        .hero-btn:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 60px rgba(211, 47, 47, 0.6), inset 0 2px 0 rgba(255, 255, 255, 0.3);
        }

        .diet-card-horizontal:active {
            transform: scale(0.98);
        }

        .card-hint-icon {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 10px;
            color: rgba(0, 0, 0, 0.4);
            background: rgba(255, 255, 255, 0.5);
            padding: 2px 6px;
            border-radius: 10px;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            backdrop-filter: blur(2px);
        }

        .hero-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.6s;
        }

        .hero-btn:hover::before {
            left: 100%;
        }

        .hero-btn:disabled {
            background: #222;
            box-shadow: none;
            color: #555;
            cursor: not-allowed;
            transform: none;
        }

        .wizard-header {
            padding: 25px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .brand-logo {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 22px;
            letter-spacing: 2px;
            color: var(--white);
        }

        .brand-logo span {
            color: var(--red);
        }

        .progress-bar {
            width: 150px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--red);
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Slides */
        .wizard-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            opacity: 0;
            transform: translateX(50px);
            pointer-events: none;
            transition: all 0.4s ease-in-out;
            overflow-y: auto;
            /* Allow scroll on small vertical screens */
            align-items: center;
            /* Center all slide content */
            text-align: center;
            /* Center text by default */
        }

        .slide.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
            z-index: 10;
        }

        .slide.prev {
            opacity: 0;
            transform: translateX(-50px);
        }

        /* Typography */
        h2 {
            text-align: center;
            /* Force center */
            width: 100%;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 14px;
            /* Drastically reduced for maximum air */
            line-height: 1.2;
            margin-bottom: 8px;
        }

        @media (min-width: 768px) {
            h2 {
                font-size: 16px;
            }
        }

        h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 15px;
            color: #ddd;
        }

        p.hint {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* ============================================
           3. COMPONENTES DE FORMULARIO
           ============================================ */
        /* Context Pill Global Style */
        .context-pill {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 9px;
            color: #ccc;
            margin-bottom: 20px;
            /* Space below pill */
            margin-top: 15px;
            /* Even more separation from H2 for air as requested */
        }

        .context-pill span {
            margin-right: 5px;
        }

        /* Inputs */
        input[type="text"],
        input[type="number"],
        .input-group input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 2px solid #444;
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 32px;
            font-weight: 700;
            padding: 10px 0;
            outline: none;
            transition: border-color 0.3s;
            text-transform: capitalize;
        }

        /* Hover logic for clearer UI (Step 4 & 2) */
        .compact-opt .opt-desc,
        .compact-opt .breed-hover,
        .size-opt .breed-hover,
        .size-opt .size-opt-sub {
            opacity: 0;
            height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Show on hover */
        .compact-opt:hover .opt-desc,
        .compact-opt:hover .breed-hover {
            opacity: 1;
            height: auto;
            margin-top: 5px;
        }

        .size-opt:hover .breed-hover {
            opacity: 1;
            height: auto;
            margin-top: 2px;
        }

        /* Unique behavior for Size: Hide label/sub on hover? User said "Show examples...". */
        /* Let's keep label visible, show breed hover */

        .big-option,
        .compact-opt,
        .size-opt {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Step 1 Input Cleanup */
        .input-group input:focus {
            border-bottom: 2px solid var(--red);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #111;
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            /* Fixed height like v3 */
            overflow: hidden;
            background-image: radial-gradient(circle at 10% 20%, #222 0%, #111 90%);
        }

        /* Spacer logic: Hide on desktop, show on mobile */
        .spacer {
            display: none;
        }

        @media (max-width: 768px) {
            /* Spacer logic handled in lower block */
        }

        /* Glass Cards for Options */
        .option-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Premium Option Cards (Aligned with Results) */
        .big-option {
            background: linear-gradient(145deg, #252525, #1a1a1a);
            border: 1px solid #333;
            border-radius: 18px;
            /* Softer radius */
            padding: 15px 20px;
            /* Better padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 140px;
            /* More elegant compact size */
            margin: 0 auto;
        }

        .big-option:hover {
            transform: translateY(-5px);
            border-color: #555;
            background: linear-gradient(145deg, #2a2a2a, #202020);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .big-option.selected {
            border: 2px solid var(--red);
            background: linear-gradient(145deg, #2a1a1a, #1a1a1a);
            box-shadow: 0 0 25px rgba(211, 47, 47, 0.25);
        }

        /* Added specific selected style for sizes */
        .size-opt.selected {
            border: 2px solid var(--red) !important;
            background: linear-gradient(145deg, #2a1a1a, #1a1a1a) !important;
            box-shadow: 0 0 25px rgba(211, 47, 47, 0.25) !important;
            transform: translateY(-5px);
        }

        .bg-emoji {
            font-size: 40px;
            display: block;
            margin-bottom: 10px;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
            transition: transform 0.3s;
        }

        .big-option:hover .bg-emoji {
            transform: scale(1.1) rotate(5deg);
        }

        .opt-label {
            font-weight: 800;
            font-size: 11px;
            /* More elegant */
            letter-spacing: 1.5px;
            color: #fff;
            text-transform: uppercase;
        }

        .question-subtitle {
            font-size: 11px;
            color: #888;
            margin-bottom: 25px;
            text-align: left;
        }

        /* Context Pill - "Why we ask?" */
        .context-pill {
            display: inline-block;
            background: #222;
            border: 1px solid #333;
            color: #999;
            font-size: 10px;
            padding: 8px 16px;
            border-radius: 50px;
            margin-bottom: 35px;
            /* Significant air below */
            margin-top: 5px;
        }

        .context-pill span {
            margin-right: 5px;
        }

        /* H2 Titles Refresh */
        h2 {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 25px;
            /* Increased for air */
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, #aaa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Compact Flex Layout for Sizes (3 top, 2 bottom) */
        .sizes-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .size-opt {
            flex: 0 1 calc(33.33% - 12px);
            min-width: 130px;
            padding: 12px 10px !important;
            min-height: 110px;
            /* More compact */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #222, #181818) !important;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 16px !important;
            /* Elegant rounded corners */
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
        }

        /* Hover consistency with Step 1 */
        .size-opt:hover {
            transform: translateY(-5px) !important;
            border-color: #666 !important;
            background: linear-gradient(145deg, #2a2a2a, #202020) !important;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3) !important;
        }

        .size-opt.wide {
            /* No special width needed in flex centered Layout, 
               but we can make the last two slightly wider if we want, 
               or just let them be consistent. Let's keep consistent width. */
            width: auto;
        }

        /* Gigante full width */

        /* New Input Stlye */
        .input-group p {
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 10px !important;
            color: var(--red) !important;
            margin-bottom: 8px;
        }

        .input-group input {
            background: rgba(0, 0, 0, 0.3) !important;
            border-radius: 12px;
            border: 1px solid #333 !important;
            padding: 15px !important;
            font-size: 20px !important;
            text-align: center;
        }

        .input-group input:focus {
            border-color: var(--red) !important;
            background: rgba(0, 0, 0, 0.5) !important;
        }

        /* RESULTS PAGE REDESIGN v3.4 */
        .summary-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 8px 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 10px;
        }

        .question-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 8px;
            text-align: left;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .sum-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #ddd;
        }

        .sum-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
            opacity: 0.7;
        }

        .sum-val {
            font-weight: 600;
            color: #fff;
        }

        .btn-edit-float {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-edit-float:hover {
            background: var(--red);
            transform: rotate(90deg);
        }

        .btn-edit {
            display: none;
        }

        /* Result Cards Animation Restoration */
        .result-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            border-left: 3px solid var(--card-color, #fff);
            border-radius: 8px;
            padding: 6px 12px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .result-card:hover {
            transform: scale(1.02) translateX(5px);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .rc-info {
            flex: 1;
        }

        .rc-title {
            font-weight: 800;
            font-size: 16px;
            color: #fff;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .rc-tag {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--card-color);
            background: rgba(255, 255, 255, 0.05);
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .rc-grams {
            text-align: right;
            font-weight: 900;
            font-size: 24px;
            color: var(--card-color);
            line-height: 1;
        }

        .rc-grams span {
            display: block;
            font-size: 11px;
            color: #888;
            font-weight: 400;
            margin-top: 2px;
        }

        /* Hover Detail Expansion (Restored) */
        .result-card::after {
            content: 'Ver detalle Nutrici&oacute;nal â†’';
            position: absolute;
            bottom: 5px;
            right: 20px;
            font-size: 9px;
            color: #aaa;
            opacity: 0;
            transform: translateY(10px);
            transition: 0.3s;
        }

        .result-card:hover::after {
            opacity: 1;
            transform: translateY(0);
        }

        .result-card:hover {
            padding-bottom: 25px;
            /* Make space for the text */
        }

        /* RESULTS v5 - FINAL POLISH */
        /* 1. CLOSED & ORGANIZED PROFILE CARD */
        .pet-id-header {
            background: #1a1a1a;
            border: 1px solid #333;
            border-top: 4px solid var(--gold);
            /* closed top visualization */
            border-radius: 10px;
            padding: 8px 15px;
            margin-bottom: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .pet-summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: center;
        }

        .pet-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #222;
            border: 2px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .pet-data-rows {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* 2 columns for neatness */
            gap: 10px;
        }

        .p-data-item {
            display: flex;
            flex-direction: column;
        }

        .p-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 3px;
        }

        /* ============================================
           4. SECCIÓN DE RESULTADOS
           ============================================ */
        /* 4. DISCLAIMERS SECTION */
        .disclaimer-box {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 6px 12px;
            margin-top: 5px;
            font-size: 11px;
            color: #777;
            line-height: 1.6;
            text-align: left;
        }

        .disclaimer-box strong {
            color: #999;
        }

        .disclaimer-box ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        .disclaimer-box li {
            margin-bottom: 5px;
        }

        /* 5. NAVIGATION FIX */
        .results-nav {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-back-edit {
            background: none;
            border: none;
            color: #555;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            padding: 10px;
        }

        .btn-back-edit:hover {
            color: #888;
        }


        /* 2. HORIZONTAL DIET CARDS (Wide Stack) */
        .results-stack {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
        }

        .diet-card-horizontal-OLD {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(90deg, #1e1e1e, #181818);
            border: 1px solid #333;
            border-left-width: 6px;
            /* Color Border */
            border-radius: 8px;
            padding: 8px 12px;
            position: relative;
            transition: transform 0.2s;
        }

        .diet-card-horizontal-OLD:hover {
            transform: translateX(5px);
            background: #222;
        }

        .dc-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dc-icon {
            font-size: 20px;
        }

        .dc-info {
            display: flex;
            flex-direction: column;
        }

        .dc-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dc-desc {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }

        .dc-right {
            text-align: right;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .dc-grams {
            font-size: 24px;
            font-weight: 950;
            color: #fff;
            line-height: 1;
        }

        .dc-unit {
            font-size: 8px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1px;
        }

        /* ============================================
           FLIP CARD ANIMATION
           ============================================ */
        .diet-card-horizontal {
            cursor: pointer;
            perspective: 1000px;
            position: relative;
            min-height: 60px;
            display: block !important;
        }

        .diet-card-horizontal:hover {
            transform: none !important;
        }

        .card-inner {
            position: relative;
            width: 100%;
            min-height: 60px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .diet-card-horizontal.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front,
        .card-back {
            width: 100%;
            min-height: 60px;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .card-front {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(90deg, #1e1e1e, #181818);
            border: 1px solid #333;
            border-left-width: 6px;
            border-radius: 8px;
            padding: 8px 12px;
        }

        .card-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotateY(180deg);
            background: linear-gradient(90deg, #1e1e1e, #181818);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-sizing: border-box;
        }

        .card-back-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        .card-back-description {
            font-size: 10px;
            line-height: 1.5;
            color: #aaa;
        }


        /* 3. COMPACT BUTTONS ROW */
        .final-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            width: 100%;
            justify-content: center;
        }

        .btn-action-small {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            max-width: 200px;
            /* Limit size */
            transition: all 0.2s;
        }

        .btn-whatsapp-small {
            background: linear-gradient(90deg, #25D366, #128C7E);
            color: #fff;
            box-shadow: 0 4px 10px rgba(37, 211, 102, 0.2);
        }

        .btn-whatsapp-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4);
        }

        .btn-reset-small {
            background: transparent;
            border: 1px solid #444;
            color: #aaa;
        }

        .btn-reset-small:hover {
            border-color: #fff;
            color: #fff;
        }




        .big-option-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 4px;
        }

        /* New Feeding Tip */
        .feeding-tip {
            font-size: 12px;
            color: #aaa;
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .feeding-tip span {
            font-size: 16px;
        }

        .btn-whatsapp {
            background: linear-gradient(90deg, #25D366, #128C7E);
            color: white;
            width: 100%;
            border: none;
            padding: 18px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 16px;
            letter-spacing: 0.5px;
            margin-top: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .btn-whatsapp:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
        }

        .support-text {
            text-align: center;
            font-size: 12px;
            color: #777;
            margin-top: 15px;
            line-height: 1.4;
        }

        .support-text strong {
            color: #aaa;
        }

        .btn-new-calc {
            background: transparent;
            color: #666;
            width: 100%;
            border: 1px solid #333;
            padding: 12px;
            border-radius: 50px;
            font-weight: 600;
            margin-top: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
        }

        .btn-new-calc:hover {
            border-color: #666;
            color: #ccc;
        }

        .history-section {
            border-top: 1px solid #222;
            padding-top: 20px;
            margin-top: 25px;
        }

        .pet-id-header {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
            /* removed min-height to eliminate empty space */
        }

        /* Pet Switcher UI */
        .pet-switcher-grid {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .pet-card-mini {
            background: linear-gradient(145deg, #252525, #1d1d1d);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 10px 15px;
            min-width: 140px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .pet-card-mini:hover {
            background: linear-gradient(145deg, #2a2a2a, #222);
            border-color: #555;
        }

        .pet-card-mini.active {
            border-color: var(--gold);
            background: linear-gradient(145deg, #2a251a, #1a160a);
        }

        .pcm-icon {
            font-size: 20px;
        }

        .pcm-info {
            display: flex;
            flex-direction: column;
        }

        .pcm-name {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
        }

        .pcm-sub {
            font-size: 10px;
            color: #888;
        }

        .size-opt-sub {
            font-size: 9px;
            color: #666;
        }

        /* ... Merged Styles from Body ... */
        /* Step 3 Styles */
        .input-grid-row {
            display: flex;
            gap: 15px;
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
        }

        .input-card {
            background: linear-gradient(145deg, #222, #1a1a1a);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .input-card:focus-within {
            border-color: var(--red);
            box-shadow: 0 0 20px rgba(211, 47, 47, 0.15);
            transform: translateY(-2px);
        }

        .input-card label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .input-row-modern {
            display: flex;
            gap: 20px;
            justify-content: center;
            width: 100%;
        }

        .input-box-modern {
            background: linear-gradient(145deg, #222, #1a1a1a);
            border: 1px solid #333;
            border-radius: 20px;
            padding: 20px 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .input-box-modern:focus-within {
            border-color: var(--red);
            background: linear-gradient(145deg, #2a2a2a, #202020);
            box-shadow: 0 8px 25px rgba(211, 47, 47, 0.15);
            transform: translateY(-3px);
        }

        .input-box-modern label {
            font-family: 'Montserrat', sans-serif;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #777;
            margin-bottom: 12px;
        }

        .input-box-modern input {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            width: 100%;
            outline: none;
        }

        .trust-pill {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #333;
            color: #888;
            padding: 8px 18px;
            border-radius: 50px;
            font-size: 10px;
            margin-bottom: 35px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Step 4 Styles */
        .compact-opt .hover-tip {
            opacity: 0 !important;
            max-height: 0;
            overflow: hidden;
            margin: 0 !important;
            font-size: 11px;
            font-weight: 500;
            color: #fff;
            text-align: center;
            transition: all 0.3s ease;
            width: 100%;
            line-height: 1.2;
        }

        .compact-opt:hover .hover-tip {
            opacity: 1 !important;
            max-height: 50px;
            margin-top: 8px !important;
        }

        .compact-opt {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 16px !important;
            background: linear-gradient(145deg, #222, #1a1a1a);
            border: 1px solid #333;
            overflow: visible !important;
            padding: 15px 5px !important;
            min-height: 110px !important;
        }

        /* Step 5 Styles */
        .custom-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f1c40f, #e74c3c);
            outline: none;
            margin: 50px 0 30px 0;
            transition: all 0.3s;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 242, 254, 0.3);
        }

        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #fff;
            border: 4px solid #222;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            transition: transform 0.2s;
        }

        .custom-range::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Removed redundant .compact-opt block */

        /* Step Result Styles */
        /* Step Result Styles */
        #stepResult {
            justify-content: flex-start !important;
            padding-top: 40px !important;
            padding-bottom: 30px;
            position: relative;
            z-index: 10;
        }

        #stepResult~.wizard-header,
        body:has(#stepResult.active) .wizard-header {
            padding: 8px 30px;
            gap: 5px;
        }

        body:has(#stepResult.active) .wizard-header img.brand-logo {
            height: 115px !important;
        }

        body:has(#stepResult.active) .progress-bar {
            display: none !important;
        }

        /* Results Summary Grid */
        .results-summary-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px 12px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .results-summary-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px 5px;
            }
        }

        h2.res-title {
            text-align: center;
            margin-bottom: 8px;
            margin-top: 0px;
            font-size: 20px;
            letter-spacing: -0.5px;
        }

        p.res-sub {
            text-align: center;
            font-size: 13px;
            color: #888;
            margin-bottom: 4px;
        }

        /* Removed redundant .size-opt block */

        .size-opt:hover {
            border-color: #666;
            background: linear-gradient(145deg, #2a2a2a, #202020);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .size-opt.selected {
            border-color: var(--gold);
            background: linear-gradient(145deg, #2a251a, #1a160a);
        }

        /* Enforce Hover Logic */
        .size-opt .breed-hover {
            opacity: 0 !important;
            max-height: 0;
            margin: 0 !important;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .size-opt:hover .breed-hover {
            opacity: 1 !important;
            max-height: 40px;
            /* Allow enough space for multi-line */
            margin-top: 5px !important;
        }

        /* Mobile Layout Optimizations - Spacer Fix */
        .spacer {
            display: none;
            /* Hidden by default on desktop */
            height: 120px;
            width: 100%;
            clear: both;
        }

        @media (max-width: 768px) {
            .spacer {
                display: block;
                /* Only show on mobile */
            }

            #stepResult {
                padding-bottom: 150px !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* --- OPTIMIZATION UTILITIES (Refactored) --- */
        .flex-center-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* ... existing utilities ... */

        /* NEW UTILITIES FOR STEPS 3-5 */
        .step-subtitle-h3 {
            font-size: 11px;
            font-weight: 700;
            color: #555;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-left: 3px solid var(--red);
            padding-left: 12px;
        }

        .step-subtitle-h3.blue-border {
            border-left-color: var(--blue-product);
        }

        .life-option-card {
            width: 115px;
            min-height: 115px;
            height: auto;
            border-radius: 18px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .step5-grid-labels {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 12px;
            font-family: 'Montserrat', sans-serif;
        }

        .step5-label-item {
            font-size: 8px;
            font-weight: 700;
            color: #888;
        }

        .step5-label-item.ideal {
            font-size: 9px;
            font-weight: 800;
            color: #fff;
            transform: scale(1.1);
        }

        .cond-display-box {
            display: none;
            background: linear-gradient(135deg, #222, #111);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 10px 15px;
            margin-top: 20px;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-input-container {
            max-width: 280px;
            margin: 0 auto 30px auto;
            position: relative;
        }

        .hero-input-label {
            text-align: center;
            color: #555;
            font-size: 10px;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .hero-input-field {
            text-align: center;
            font-size: 18px !important;
            padding: 18px !important;
            border-radius: 16px !important;
            background: rgba(255, 255, 255, 0.03) !important;
        }

        .step1-input-container {
            max-width: 255px;
            margin: 0 auto 45px auto;
            position: relative;
            text-align: center;
        }

        .step1-label {
            display: block;
            font-size: 10px;
            color: #777;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 15px;
            letter-spacing: 1.5px;
        }

        .step1-input {
            text-align: center;
            font-size: 26px;
            padding: 10px 0;
            border-bottom: 2px solid #333;
        }

        .option-grid-centered {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            max-width: 255px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        .big-option-card {
            flex: 1;
            height: 120px;
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .size-Layout-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            max-width: 550px;
            margin: 0 auto;
        }

        .size-card-item {
            flex: 1 1 30%;
            min-width: 100px;
            max-width: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Edit Badge Interaction */
        .badge-edit {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .badge-edit:hover {
            opacity: 0.8;
            transform: scale(1.05);
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <div class="calculator-container">
        <div class="wizard-header">
            <img src="logo Mr doggie fondo negro.png" alt="Mr. Doggie" class="brand-logo"
                style="height: 160px; width: auto; mix-blend-mode: lighten; filter: brightness(1.1);">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="wizard-content">
            <!-- Paso 0: Intro & Client HERO -->
            <!-- Paso 0: Intro & Client HERO v4.1 -->
            <!-- Paso 0: Intro & Client HERO v4.1 -->
            <div class="slide active flex-center-col" id="step0">

                <div class="hero-img-container" id="heroImgContainer">
                    <!-- Assets will go here -->
                </div>

                <h2 class="hero-title" style="margin-bottom: 30px;">Nutrici&oacute;n Real<br>para tu Consentido</h2>

                <div class="input-group hero-input-container">
                    <p class="hero-input-label">&iquest;CÓMO TE LLAMAS?</p>
                    <input type="text" id="clientName" placeholder="Tu nombre..." oninput="validateStep0()"
                        class="hero-input-field">
                </div>

                <button class="hero-btn" id="btnStart" onclick="nextStep()" disabled
                    style="padding: 12px 30px; font-size: 13px;">
                    COMENZAR EL CAMBIO
                </button>
                <p style="margin-top:25px; color:#444; font-size:11px; font-weight:500;">Dise&ntilde;ado con ciencia y
                    amor
                    🩺💙</p>
            </div>

            <!-- ... Pasos Intermedios sin cambios ... -->
            <!-- Paso 1: Tipo de Info -->
            <div class="slide" id="step1">
                <h2>&iquest;A qui&eacute;n vamos a consentir hoy?</h2>
                <div class="context-pill"><span>💝</span> Porque tu mejor amigo merece lo mejor.</div>

                <!-- Step 1 Layout Fix -->
                <div class="input-group step1-input-container">
                    <label class="step1-label">
                        NOMBRE DE TU MASCOTA
                    </label>
                    <input type="text" id="petName" placeholder="Ej. Thor, Luna..." oninput="validateStep1()"
                        autocomplete="off" class="step1-input">
                </div>

                <!-- Buttons with Flexible Width matching Input -->
                <div class="option-grid option-grid-centered">
                    <div class="big-option big-option-card" id="optDog" onclick="selectType('dog')">
                        <img src="icon_dog_minimal_3d.png" width="60"
                            style="margin-bottom:12px; opacity:0.9; mix-blend-mode: lighten; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.4));">
                        <div class="opt-label" style="font-size:12px; letter-spacing:2px; font-weight:800;">PERRO</div>
                    </div>
                    <div class="big-option big-option-card" id="optCat" onclick="selectType('cat')">
                        <img src="icon_cat_minimal_3d.png" width="60"
                            style="margin-bottom:12px; opacity:0.9; mix-blend-mode: lighten; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.4));">
                        <div class="opt-label" style="font-size:12px; letter-spacing:2px; font-weight:800;">GATO</div>
                    </div>
                </div>
            </div>

            <!-- Paso 2: TAMA&Ntilde;O (Solo Perros) -->
            <div class="slide" id="step2_Size">
                <h2>&iquest;De qu&eacute; TAMA&Ntilde;O es?</h2>
                <div class="context-pill"><span>⚖️</span> Para calcular la capacidad de su est&oacute;mago y
                    porci&oacute;n exacta.
                </div>

                <!-- Creative Ma&ntilde;onry-like Layout for Sizes (Restored Hover) -->
                <div class="size-Layout-creative size-Layout-grid">

                    <!-- Top Row: 3 Items -->
                    <div class="size-opt size-card-item" onclick="selectSize('mini', this)">
                        <img src="icon_size_mini_glass.png" width="45" alt="TAMA&Ntilde;O Mini"
                            style="margin-bottom:8px; opacity:0.9; mix-blend-mode: lighten;">
                        <div class="opt-label">MINI</div>
                        <div class="size-opt-sub">&lt; 5kg</div>
                        <div class="breed-hover" style="font-size:8px; color:#aaa; margin-top:5px; text-align:center;">
                            Chihuahua, Pinscher</div>
                    </div>
                    <div class="size-opt size-card-item" onclick="selectSize('small', this)">
                        <img src="icon_size_small_glass.png" width="45" alt="TAMA&Ntilde;O Peque&ntilde;o"
                            style="margin-bottom:8px; opacity:0.9; mix-blend-mode: lighten;">
                        <div class="opt-label">PEQUEÑO</div>
                        <div class="size-opt-sub">5-10kg</div>
                        <div class="breed-hover" style="font-size:8px; color:#aaa; margin-top:5px; text-align:center;">
                            Pug, Frenchie</div>
                    </div>
                    <div class="size-opt size-card-item" onclick="selectSize('medium', this)">
                        <img src="icon_size_medium_glass.png" width="50" alt="TAMA&Ntilde;O Mediano"
                            style="margin-bottom:8px; opacity:0.9; mix-blend-mode: lighten;">
                        <div class="opt-label">Mediano</div>
                        <div class="size-opt-sub">10-25kg</div>
                        <div class="breed-hover" style="font-size:8px; color:#aaa; margin-top:5px; text-align:center;">
                            Beagle, Cocker</div>
                    </div>

                    <!-- Bottom Row: 2 Items centered -->
                    <div class="size-opt size-card-item" onclick="selectSize('large', this)"
                        style="margin-top: 5px; min-width: 120px; max-width: 160px;">
                        <img src="icon_size_large_glass.png" width="55" alt="TAMA&Ntilde;O Grande"
                            style="margin-bottom:8px; opacity:0.9; mix-blend-mode: lighten;">
                        <div class="opt-label">GRANDE</div>
                        <div class="size-opt-sub">25-45kg</div>
                        <div class="breed-hover" style="font-size:8px; color:#aaa; margin-top:5px; text-align:center;">
                            Golden, Boxer</div>
                    </div>
                    <div class="size-opt size-card-item" onclick="selectSize('giant', this)"
                        style="margin-top: 5px; min-width: 120px; max-width: 160px;">
                        <img src="icon_size_giant_glass.png" width="65" alt="TAMA&Ntilde;O Gigante"
                            style="margin-bottom:8px; opacity:0.9; mix-blend-mode: lighten; transform: scaleX(-1);">
                        <div class="opt-label">GIGANTE</div>
                        <div class="size-opt-sub">&gt; 45kg</div>
                        <div class="breed-hover" style="font-size:8px; color:#aaa; margin-top:5px; text-align:center;">
                            Gran Dan&eacute;s, Terra&ntilde;ova</div>
                    </div>
                </div>
            </div>

            <!-- Paso 3: Peso y Edad (Friendly Profile) -->
            <div class="slide" id="step3_Phys">
                <h2>&iquest;Hablemos de su cuerpo?</h2>
                <div class="context-pill"><span>📋</span> Datos fisiológicos clave.</div>



                <div class="trust-pill">
                    <span>🔒</span> Para calcular la porci&oacute;n exacta, necesitamos conocer estos detalles
                    f&iacute;sicos.
                </div>

                <div class="input-grid-row input-row-modern" style="max-width: 85%; margin: 0 auto; gap: 10px;">
                    <!-- Age -->
                    <div class="input-card" style="padding: 10px;">
                        <label class="compact-label"
                            style="display:block; font-size:9px; font-weight:700; color:#555; margin-bottom:5px; text-transform:uppercase; letter-spacing:1px;">EDAD</label>
                        <div class="input-box-modern"
                            style="display:flex; align-items:center; gap:10px; padding: 5px 10px;">
                            <div style="flex:1;">
                                <input type="number" id="petAgeYear" placeholder="0" oninput="validatePhysStep()"
                                    style="font-size: 20px; padding:0;">
                                <div style="font-size:8px; color:#555; font-weight:600; text-align:center;">AÑOS</div>
                            </div>
                            <div id="monthsContainer"
                                style="display:none; flex:1; border-left:1px solid #333; padding-left:10px;">
                                <input type="number" id="petAgeMonth" placeholder="0" oninput="validatePhysStep()"
                                    style="font-size: 20px; padding:0;">
                                <div style="font-size:8px; color:#555; font-weight:600; text-align:center;">MESES</div>
                            </div>
                        </div>
                    </div>
                    <!-- Weight -->
                    <div class="input-card" style="padding: 10px;">
                        <label class="compact-label"
                            style="display:block; font-size:9px; font-weight:700; color:#555; margin-bottom:5px; text-transform:uppercase; letter-spacing:1px;">PESO
                            (KG)</label>
                        <div class="input-box-modern" style="padding: 5px 10px;">
                            <input type="number" id="petWeight" placeholder="0.0" oninput="validatePhysStep()"
                                step="0.1" style="font-size: 20px; padding:0;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paso 4: Estilo de Vida (Friendly Activity) -->
            <div class="slide" id="step4_Life">
                <h2>&iquest;C&oacute;mo es su actividad diaria?</h2>
                <div class="context-pill"><span>⚡</span> Para calcular su gasolina diaria.</div>

                <div style="display:flex; flex-direction:column; gap:30px; width:100%; max-width:650px;">

                    <!-- Secci&oacute;n Actividad -->
                    <div id="dogActivitySection">
                        <h3 class="step-subtitle-h3">
                            Nivel de Actividad
                        </h3>
                        <div class="option-grid option-grid-centered">
                            <div class="big-option compact-opt life-option-card" onclick="selectActivity('low', this)">
                                <img src="icon_act_low_silver.png" width="55"
                                    style="margin-bottom:12px; mix-blend-mode: lighten;" alt="Actividad Tranquila"
                                    onerror="this.src='icon_dog_minimal_3d.png'">
                                <div class="opt-label" style="font-size:10px; font-weight:800; letter-spacing:1px;">
                                    TRANQUILO</div>
                                <div class="hover-tip">1 salida&ntilde;o menos al dia</div>
                            </div>
                            <div class="big-option compact-opt life-option-card" onclick="selectActivity('med', this)">
                                <img src="icon_act_med_silver.png" width="55"
                                    style="margin-bottom:12px; mix-blend-mode: lighten;" alt="Actividad Normal"
                                    onerror="this.src='icon_dog_minimal_3d.png'">
                                <div class="opt-label" style="font-size:10px; font-weight:800; letter-spacing:1px;">
                                    NORMAL</div>
                                <div class="hover-tip">2 o 3 salidas al dia</div>
                            </div>
                            <div class="big-option compact-opt life-option-card" onclick="selectActivity('high', this)">
                                <img src="icon_act_high_silver.png" width="55"
                                    style="margin-bottom:12px; mix-blend-mode: lighten;" alt="Actividad Muy Activo"
                                    onerror="this.src='icon_dog_minimal_3d.png'">
                                <div class="opt-label" style="font-size:10px; font-weight:800; letter-spacing:1px;">
                                    ACTIVO</div>
                                <div class="hover-tip">mas de 4 salidas al dia</div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci&oacute;n Esteriliza&ntilde;o -->
                    <div>
                        <h3 class="step-subtitle-h3 blue-border">
                            CONDICI&Oacute;N Reproductiva
                        </h3>
                        <div
                            style="font-size:12px; color:#888; margin-bottom:10px; margin-left:15px; font-style:italic;">
                            &iquest;Tu consentido est&aacute; esteriliza&ntilde;o?</div>

                        <div class="option-grid option-grid-centered">
                            <div class="big-option compact-opt btn-neutered life-option-card"
                                onclick="selectNeutered(true, this)">
                                <img id="imgNeuteredYes" src="icon_status_neutered_silver.png" width="50"
                                    style="margin-bottom:10px; mix-blend-mode: lighten;" alt="S&iacute;">
                                <div class="opt-label" style="font-size:10px; font-weight:800; letter-spacing:1px;">SÍ
                                </div>
                                <div class="hover-tip">Meta&ntilde;olismo lento</div>
                            </div>
                            <div class="big-option compact-opt btn-neutered life-option-card"
                                onclick="selectNeutered(false, this)">
                                <img id="imgNeuteredNo" src="icon_status_intact_silver.png" width="50"
                                    style="margin-bottom:10px; mix-blend-mode: lighten;" alt="No">
                                <div class="opt-label" style="font-size:10px; font-weight:800; letter-spacing:1px;">NO
                                </div>
                                <div class="hover-tip">Meta&ntilde;olismo est&aacute;ndar</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Paso 5: CONDICI&Oacute;N (Visual Slider) -->
            <div class="slide" id="step5_Cond">
                <h2>Va&ntilde;os a ser honestos, &iquest;c&oacute;mo sientes su cuerpito?</h2>
                <div class="context-pill"><span>🩺</span> Es importante saber el estado físico de tu
                    perro para saber
                    cómo ayudarlo.</div>

                <!-- Slider Full Width with 7 Labels -->
                <div class="range-container" style="width:100%; max-width:100%; margin: 20px 0 40px 0; padding:0;">

                    <!-- 7 GUIDE LABELS GRID -->
                    <div class="step5-grid-labels">
                        <span class="step5-label-item">MUY<br>Delgado</span>
                        <span class="step5-label-item">Delgado</span>
                        <span class="step5-label-item">Ba&ntilde;o<br>PESO</span>
                        <span class="step5-label-item ideal">IDEAL</span>
                        <span class="step5-label-item">SOBRE<br>PESO</span>
                        <span class="step5-label-item">OBESO</span>
                        <span class="step5-label-item">OBESIDAD<br>EXTREMA</span>
                    </div>

                    <div style="position:relative; padding:0 5px;">
                        <!-- Track Line Removed to reveal gradient -->

                        <input type="range" id="bodyCondition" min="1" max="7" class="custom-range"
                            style="margin: 0; width:100%; position:relative; z-index:2; height:12px;"
                            oninput="updateCondition(this.value, true)" onchange="updateCondition(this.value, true)"
                            onmousedown="userInteractedCond()" ontouchstart="userInteractedCond()">

                        <!-- Ticks for 7 positions -->
                        <div
                            style="display:flex; justify-content:space-between; padding:0 12px; margin-top:-14px; position:relative; z-index:1; pointer-events:none;">
                            <span style="width:2px; height:8px; background:#555;"></span>
                            <span style="width:2px; height:8px; background:#555;"></span>
                            <span style="width:2px; height:8px; background:#555;"></span>
                            <span style="width:2px; height:8px; background:#fff; box-shadow:0 0 5px white;"></span>
                            <span style="width:2px; height:8px; background:#555;"></span>
                            <span style="width:2px; height:8px; background:#555;"></span>
                            <span style="width:2px; height:8px; background:#555;"></span>
                        </div>
                    </div>
                </div>

                <!-- Compact Diagnostic Card -->
                <div id="condDisplayBox" class="cond-display-box">
                    <div
                        style="width:8px; height:35px; background:var(--gold); border-radius:4px; box-shadow: 0 0 10px var(--gold);">
                    </div>
                    <div style="text-align:left; flex:1;">
                        <div style="font-size:8px; color:#555; letter-spacing:1px; margin-bottom:2px; font-weight:700;">
                            DIAGNÓSTICO
                        </div>
                        <div id="condLabel"
                            style="font-size:16px; font-weight:800; color:#fff; letter-spacing:-0.5px; line-height:1.1;">
                            Peso Ideal</div>
                        <div id="condDesc" style="font-size:10px; color:#888; margin-top:2px;">Costillas palpables.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paso 6: Resulta&ntilde;os GOURMET -->
            <div class="slide" id="stepResult">

                <h2 class="res-title" id="resTitle">Tu Plan Nutrici&oacute;nal ✨</h2>
                <p class="res-sub" id="resSub">Dise&ntilde;ado espec&iacute;ficamente para las necesidades de:</p>

                <div id="resultHeaderArea" style="width:100%; max-width:100%; margin:0; padding:0;"></div>
                <!-- Header Injected Here -->

                <div class="results-grid" id="resultsList" style="width:100%; max-width:100%;">
                    <!-- Cards Injected Here -->
                </div>

                <!-- Action Buttons (Wider and Flatter) -->
                <div id="advisorWarning"
                    style="display:none; background: linear-gradient(135deg, #8B0000, #B22222); padding: 18px 25px; margin-bottom: 20px; border-radius: 16px; border-left: 4px solid #ff0000; box-shadow: 0 8px 25px rgba(139,0,0,0.4);">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="font-size:32px;">âš ✨</div>
                        <div>
                            <div style="font-size:14px; font-weight:800; color:#fff; margin-bottom:5px;">Alerta de
                                Salud</div>
                            <div style="font-size:12px; line-height:1.5; color:#ffc;">Su mascota presenta una
                                CONDICI&Oacute;N corporal cr&iacute;tica. Le recomendatos <strong>consultar con nuestro
                                    asesor
                                    experto</strong> para un plan personaliza&ntilde;o.</div>
                        </div>
                    </div>
                </div>

                <div
                    style="display:flex; flex-direction:row; align-items: stretch; gap:15px; width:100%; max-width:100%; margin-top:20px;">
                    <button class="btn-new-calc" onclick="resetCalculamor()"
                        style="flex: 1; padding: 10px 10px; font-size: 12px; border-radius:12px; background:rgba(255,255,255,0.08); color:#ddd; border:1px solid rgba(255,255,255,0.2); cursor:pointer; font-weight:600; transition:0.3s; display:flex; align-items:center; justify-content:center; white-space:nowrap;">
                        Nueva Mascota
                    </button>
                    <button class="btn-primary"
                        onclick="window.open('https://wa.me/573224761814?text=Hola!%20Necesito%20asesor&iacute;a%20para%20mi%20mascota%20✨', '_blank')"
                        style="flex: 1.5; display:flex; align-items:center; justify-content:center; gap:10px; padding: 10px 15px; font-size: 14px; border-radius:12px; background:linear-gradient(135deg, #25D366, #128C7E); color:#fff; border:none; cursor:pointer; font-weight:700; box-shadow: 0 4px 15px rgba(37,211,102,0.3); transition:0.3s;">
                        <span style="font-size:18px;">💬</span>
                        <div style="text-align:left;">
                            <div style="font-size:13px; font-weight:700; line-height:1.2;">Habla con un asesor</div>
                        </div>
                    </button>
                </div>
                <!-- Mobile Spacer to prevent cutoff -->
                <div class="spacer"></div>
            </div>
        </div> <!-- End Wizard Content Corrected -->

        <!-- Modern Sticky Nav (Global) -->
        <div class="nav-actions hidden" id="navContainer" style="z-index:9999;">
            <button class="btn-nav-back" onclick="prevStep()">
                <span>&larr;</span> Atr&aacute;s
            </button>
            <div style="display:flex; gap:10px;">
                <button id="btnQuickFinish" onclick="quickFinish()"
                    style="display:none; background:transparent; border:1px solid #555; color:#aaa; padding:15px 20px; border-radius:50px; cursor:pointer; font-weight:600; font-size:12px; transition:0.2s;">
                    ⚡ VER RESULTADOS
                </button>
                <button class="btn-nav-next" id="btnNext" onclick="nextStep()" disabled>
                    CONTINUAR <span>&rarr;</span>
                </button>
            </div>
        </div>

    </div>
    <script>
        /**
         * ------------------------------------------------------------------
         * MR. DOGGIE CALCULamor - CORE LOGIC
         * ------------------------------------------------------------------
         */

        /* --- 1. STATE MANAGEMENT --- */
        const STORAGE_KEY = 'mrdoggie_calc_v4_state'; // Persistence Key

        let currentStep = 0;
        let history = []; // Stores saved pet profiles
        let data = {
            clientName: '',
            petName: '',
            type: '', // 'dog' | 'cat'
            size: '', // 'mini' | 'small' | 'medium' | 'large' | 'giant'
            weight: 0,
            ageY: 0, ageM: 0,
            activity: '', // 'low' | 'med' | 'high'
            neutered: null, // true | false
            condition: 4 // 1 to 7 scale
        };

        /* --- PERSISTENCE LOGIC --- */
        function saveState() {
            try {
                const state = {
                    data: data,
                    currentStep: currentStep,
                    history: history,
                    hasInteractedCond: hasInteractedCond
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn('Storage failed', e);
            }
        }

        function loadState() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return false;

                const state = JSON.parse(stored);
                if (state) {
                    if (state.data) data = state.data;
                    if (typeof state.currentStep === 'number') currentStep = state.currentStep;
                    if (state.history) history = state.history;
                    if (typeof state.hasInteractedCond === 'boolean') hasInteractedCond = state.hasInteractedCond;

                    // DOM Restoration
                    restoreDOM();
                    return true;
                }
            } catch (e) {
                console.warn('Load failed', e);
            }
            return false;
        }

        function restoreDOM() {
            // Restore Inputs
            const inputs = {
                'clientName': data.clientName,
                'petName': data.petName,
                'petWeight': data.weight || '',
                'petAgeYear': data.ageY || '',
                'petAgeMonth': data.ageM || ''
            };

            for (const [id, val] of Object.entries(inputs)) {
                const el = document.getElementById(id);
                if (el) el.value = val;
            }

            // Restore Selections
            // Type
            if (data.type) {
                const dogs = document.getElementById('optDog');
                const cats = document.getElementById('optCat');
                if (dogs) dogs.classList.toggle('selected', data.type === 'dog');
                if (cats) cats.classList.toggle('selected', data.type === 'cat');
            }

            // Size
            if (data.size) {
                document.querySelectorAll('.size-opt').forEach(el => {
                    // Logic: match specific onclick or inspect element unique markers? 
                    // Better: checking if the element corresponds to the size. 
                    // The HTML has onclick="selectSize('mini', this)". 
                    // We can check the onclick attribute or just find by text/img?
                    // Easiest: The HTML for sizes is static. We can use index or selectors if they had specific IDs.
                    // They don't have IDs. Let's rely on the onclick attribute content or modify HTML to add IDs?
                    // "Restricciones: No modificar diseño... No cambiar textos".
                    // I'll assume standard layout or text content matching.
                    // Actually, I can search by onclick attribute string which contains the key.
                    const fn = el.getAttribute('onclick');
                    if (fn && fn.includes(`'${data.size}'`)) el.classList.add('selected');
                    else el.classList.remove('selected');
                });
            }

            // Activity
            if (data.activity) {
                document.querySelectorAll('.life-option-card').forEach(el => {
                    const fn = el.getAttribute('onclick');
                    if (fn && fn.includes(`selectActivity`) && fn.includes(`'${data.activity}'`)) {
                        el.classList.add('selected');
                    }
                });
            }

            // Neutered
            if (data.neutered !== null) {
                document.querySelectorAll('.btn-neutered').forEach(el => {
                    const fn = el.getAttribute('onclick');
                    if (fn && fn.includes(data.neutered.toString())) { // boolean to string 'true' or 'false'
                        el.classList.add('selected');
                    }
                });
            }

            // Condition
            if (hasInteractedCond) {
                const slider = document.getElementById('bodyCondition');
                if (slider) slider.value = data.condition;
                updateCondition(data.condition, true);
            }

            // Months visibility
            const monthsContainer = document.getElementById('monthsContainer');
            if (monthsContainer) {
                monthsContainer.style.display = (data.ageY < 2) ? 'block' : 'none';
            }
        }

        /* --- 2. CONFIGURATION --- */
        const PRODUCTS_DB = {
            dog: [
                {
                    id: 'red', name: 'Mr. Doggie Red con Pollo',
                    kcal: 1600, color: '#D32F2F',
                    ingreds: 'Pollo, V&iacute;sceras, Huesos Carnosos',
                    iconSrc: 'icon_ingredient_chicken_silver.png'
                },
                {
                    id: 'green', name: 'Mr. Doggie Green con Res',
                    kcal: 1500, color: '#388E3C',
                    ingreds: 'Res, V&iacute;sceras, Vegetales Frescos',
                    iconSrc: 'icon_ingredient_beef_silver.png'
                },
                {
                    id: 'orange', name: 'Mr. Doggie Orange con Salm&oacute;n',
                    kcal: 1450, color: '#F57C00',
                    ingreds: 'Salm&oacute;n, Pescado Blanco, Aceites',
                    iconSrc: 'icon_ingredient_salmon_silver.png'
                }
            ],
            cat: [
                {
                    id: 'blue', name: 'Mr. Doggie Blue Cat',
                    kcal: 1300, color: '#1976D2',
                    ingreds: 'Salm&oacute;n, Pollo, Coraz&oacute;n y Taurina',
                    iconSrc: 'icon_cat_minimal_3d.png'
                }
            ]
        };

        const COND_DATA = {
            1: { t: "Muy Delgado", d: "Costillas, lumbar y p&eacute;lvicos visibles. Sin grasa palpable." },
            2: { t: "Delgado", d: "Costillas f&aacute;ciles de palpar. Cintura muy marcada." },
            3: { t: "Bajo Peso", d: "Costillas palpables con poca grasa. Cintura visible." },
            4: { t: "Peso Ideal", d: "Costillas palpables con ligera grasa. Cintura observable." },
            5: { t: "Sobrepeso", d: "Costillas dif&iacute;ciles de palpar. Capa de grasa moderada." },
            6: { t: "Obeso", d: "Costillas no palpables. Capa de grasa importante." },
            7: { t: "Obesidad M&oacute;rbida", d: "Dep&oacute;sitos de grasa masivos. Distensi&oacute;n abdominal." }
        };

        /* --- 3. DOM & NAVIGATION --- */
        const progressFill = document.getElementById('progressFill');
        const navContainer = document.getElementById('navContainer');
        const btnNext = document.getElementById('btnNext');

        function getSteps() {
            if (data.type === 'cat') {
                return ['step0', 'step1', 'step3_Phys', 'step4_Life', 'step5_Cond', 'stepResult'];
            }
            return ['step0', 'step1', 'step2_Size', 'step3_Phys', 'step4_Life', 'step5_Cond', 'stepResult'];
        }

        function goToStep(arg) {
            const steps = getSteps();
            let targetIndex = -1;

            if (typeof arg === 'string') targetIndex = steps.indexOf(arg);
            else if (typeof arg === 'number') targetIndex = arg;

            if (targetIndex >= 0 && targetIndex < steps.length) {
                currentStep = targetIndex;
                updateUI();
                window.scrollTo(0, 0);
            }
        }

        function nextStep() {
            const steps = getSteps();
            if (currentStep >= steps.length - 1) return;

            // Pre-calculation Check
            if (steps[currentStep] === 'step5_Cond') {
                if (!calculate()) return;
            }

            // Animation Handling
            const currentId = steps[currentStep];
            const currEl = document.getElementById(currentId);
            if (currEl) {
                currEl.classList.add('prev');
                currEl.classList.remove('active');
            }

            currentStep++;
            updateUI();
        }

        function prevStep() {
            if (currentStep === 0) return;
            const steps = getSteps();

            // Hide current
            const currentId = steps[currentStep];
            const currEl = document.getElementById(currentId);
            if (currEl) currEl.classList.remove('active');

            currentStep--;
            updateUI();
        }

        function quickFinish() {
            if (calculate()) {
                const steps = getSteps();
                currentStep = steps.length - 1;
                updateUI();
            }
        }

        function updateUI() {
            const steps = getSteps();
            const total = steps.length - 1;
            const currentId = steps[currentStep];

            // 1. Hide all slides
            document.querySelectorAll('.slide').forEach(s => {
                s.classList.remove('active', 'prev');
                s.style.display = 'none';
            });

            // 2. Show current
            const currentEl = document.getElementById(currentId);
            if (currentEl) {
                currentEl.style.display = 'flex';
                setTimeout(() => currentEl.classList.add('active'), 10);
            }

            // 3. Update Progress Bar
            const pct = (currentStep / total) * 100;
            if (progressFill) progressFill.style.width = pct + '%';

            // 4. Update Navigation Visibility
            const nav = document.getElementById('navContainer');
            if (currentStep === 0 || currentStep === total) {
                nav.classList.add('hidden');
            } else {
                nav.classList.remove('hidden');
            }

            validateCurrent();

            const t = data.type;
            if (!t) return;

            // Show/Hide Activity Section (Dogs only)
            const actSec = document.getElementById('dogActivitySection');
            if (actSec) actSec.style.display = t === 'dog' ? 'block' : 'none';

            // Update Neutered Icons based on species
            const imgYes = document.getElementById('imgNeuteredYes');
            const imgNo = document.getElementById('imgNeuteredNo');
            if (imgYes && imgNo) {
                const suffix = t === 'dog' ? '' : '_cat';
                // Note: Ensure filenames match your assets exactly
                if (t === 'dog') {
                    imgYes.src = 'icon_status_neutered_silver.png';
                    imgNo.src = 'icon_status_intact_silver.png';
                } else {
                    imgYes.src = 'icon_status_neutered_cat_silver.png';
                    imgNo.src = 'icon_status_intact_cat_silver.png';
                }
            }
        }

        /* --- 4. VALIDATION --- */
        let hasInteractedCond = false;

        function validateCurrent() {
            saveState(); // Auto-save on every validation check (triggered by inputs/nav)
            const steps = getSteps();
            const stepId = steps[currentStep];
            let valid = false;

            if (stepId === 'step0') valid = data.clientName.trim().length > 0;
            if (stepId === 'step1') valid = data.petName.trim().length > 0 && data.type !== '';
            if (stepId === 'step2_Size') valid = data.size !== '';
            if (stepId === 'step3_Phys') valid = data.weight > 0 && (data.ageY > 0 || data.ageM > 0);
            if (stepId === 'step4_Life') {
                if (data.type === 'cat') valid = data.neutered !== null;
                else valid = data.activity !== '' && data.neutered !== null;
            }
            if (stepId === 'step5_Cond') valid = hasInteractedCond;

            // Button State
            if (stepId === 'step0') {
                document.getElementById('btnStart').disabled = !valid;
            } else {
                btnNext.disabled = !valid;
            }

            // Quick Finish Button Logic
            const btnQuick = document.getElementById('btnQuickFinish');
            if (btnQuick) {
                if (stepId === 'step5_Cond' && valid) {
                    btnQuick.style.display = 'block';
                    btnNext.style.display = 'none';
                } else {
                    btnNext.style.display = 'block';
                    const allValid = checkAllDataPresent();
                    const isResult_ = currentStep === steps.length - 1;
                    if (allValid && !isResult_ && currentStep > 0) {
                        btnQuick.style.display = 'block';
                    } else {
                        btnQuick.style.display = 'none';
                    }
                }
            }
        }

        function checkAllDataPresent() {
            if (data.clientName.trim().length === 0) return false;
            if (data.petName.trim().length === 0) return false;
            if (data.type === '') return false;
            if (data.type === 'dog' && data.size === '') return false;
            if (data.weight <= 0) return false;
            if (data.ageY === 0 && data.ageM === 0) return false;
            if (data.type === 'dog' && data.activity === '') return false;
            if (data.neutered === null) return false;
            if (!hasInteractedCond) return false;
            return true;
        }

        /* --- 5. INPUT HANDLERS --- */
        function validateStep0() {
            let val = document.getElementById('clientName').value;
            if (val) val = val.replace(/\b\w/g, l => l.toUpperCase());
            data.clientName = val;
            validateCurrent();
        }

        function validateStep1() {
            let val = document.getElementById('petName').value;
            if (val) val = val.replace(/\b\w/g, l => l.toUpperCase());
            data.petName = val;
            validateCurrent();
        }

        function selectType(t) {
            data.type = t;
            document.getElementById('optDog').classList.toggle('selected', t === 'dog');
            document.getElementById('optCat').classList.toggle('selected', t === 'cat');
            updateUI(); // Triggers refreshTypeUI
        }

        function selectSize(s, el) {
            data.size = s;
            document.querySelectorAll('.size-opt').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            validateCurrent();
            // No auto-advance
        }

        function validatePhysStep() {
            data.weight = parseFloat(document.getElementById('petWeight').value) || 0;
            data.ageY = parseInt(document.getElementById('petAgeYear').value) || 0;
            const mEl = document.getElementById('petAgeMonth');
            data.ageM = mEl ? (parseInt(mEl.value) || 0) : 0;

            // Show months if age < 2 years
            const monthsContainer = document.getElementById('monthsContainer');
            if (data.ageY < 2) monthsContainer.style.display = 'block';
            else {
                monthsContainer.style.display = 'none';
                data.ageM = 0;
            }
            validateCurrent();
        }

        function selectActivity(a, el) {
            data.activity = a;
            el.parentElement.querySelectorAll('.big-option').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            validateCurrent();
        }

        function selectNeutered(n, el) {
            data.neutered = n;
            el.parentElement.querySelectorAll('.big-option').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            validateCurrent();
        }

        function updateCondition(v, fromInteract) {
            if (fromInteract) {
                hasInteractedCond = true;
                document.getElementById('condDisplayBox').style.display = 'flex';
            }
            v = parseInt(v);
            data.condition = v;

            const info = COND_DATA[v] || COND_DATA[4];
            document.getElementById('condLabel').textContent = info.t;
            document.getElementById('condDesc').textContent = info.d;
            validateCurrent();
        }

        function userInteractedCond() {
            updateCondition(document.getElementById('bodyCondition').value, true);
        }

        /* --- 6. CALCULATION ENGINE --- */

        // Calculation multipliers constants
        const MULTIPLIERS = {
            // Base multipliers by pet type
            BASE_DOG: 1.5,
            BASE_DOG_GIANT: 1.6,
            BASE_CAT: 1.4,

            // Life stage adjustments
            PUPPY_ADJUSTMENT: 0.4,      // +40% for growing puppies
            SENIOR_ADJUSTMENT: -0.3,    // -30% for senior pets

            // Neutered status adjustments
            NEUTERED_DOG: -0.1,         // -10% for neutered dogs
            NEUTERED_CAT: -0.1,         // -10% for neutered cats

            // Activity level adjustments (dogs only)
            ACTIVITY_LOW: -0.1,         // -10% for sedentary dogs
            ACTIVITY_HIGH: 0.3,         // +30% for very active dogs

            // Safety limits
            MIN_MULTIPLIER: 0.5         // Minimum allowed multiplier
        };

        /**
         * Calculate daily calorie needs and portion sizes
         * 
         * Formula: RER × Multiplier
         * Where RER = 70 × (weight in kg)^0.75
         * 
         * Multiplier = BASE + age_adjustment + neutered_adjustment + activity_adjustment
         * 
         * @returns {boolean} Success status
         */
        function calculate() {
            try {
                // RER (Resting Energy Requirement)
                const rer = 70 * Math.pow(data.weight, 0.75);

                // Base Multipliers
                let base = MULTIPLIERS.BASE_DOG;
                if (data.type === 'cat') base = MULTIPLIERS.BASE_CAT;
                else if (data.size === 'giant') base = MULTIPLIERS.BASE_DOG_GIANT;

                // Adjustments
                let adjustStage = 0;
                let isPuppy = false;

                // Senior age varies by size
                let seniorAge = 9; // Default for medium
                if (data.type === 'dog') {
                    if (data.size === 'mini' || data.size === 'small') seniorAge = 11;
                    else if (data.size === 'large') seniorAge = 8;
                    else if (data.size === 'giant') seniorAge = 7;
                } else {
                    seniorAge = 8; // Cats
                }
                let isSenior = data.ageY >= seniorAge;

                // Puppy Logic
                const totalMonths = data.ageY * 12 + data.ageM;
                if (data.type === 'cat') {
                    if (totalMonths <= 12) isPuppy = true;
                } else {
                    let limit = 12; // Small/Toy
                    if (data.size === 'medium') limit = 15;
                    if (['large', 'giant'].includes(data.size)) limit = 18;
                    if (totalMonths <= limit) isPuppy = true;
                }

                if (isSenior) adjustStage = MULTIPLIERS.SENIOR_ADJUSTMENT;
                if (isPuppy) adjustStage = MULTIPLIERS.PUPPY_ADJUSTMENT;

                let adjustNeutered = 0;
                if (data.neutered) adjustNeutered = data.type === 'dog' ? MULTIPLIERS.NEUTERED_DOG : MULTIPLIERS.NEUTERED_CAT;

                let adjustAct = 0;
                if (data.type === 'dog') {
                    if (data.activity === 'low') adjustAct = MULTIPLIERS.ACTIVITY_LOW;
                    if (data.activity === 'high') adjustAct = MULTIPLIERS.ACTIVITY_HIGH;
                }

                // Final Multiplier
                let mult = Math.max(MULTIPLIERS.MIN_MULTIPLIER, base + adjustStage + adjustNeutered + adjustAct);
                const kcalDay = rer * mult;

                // Auto-save to History
                const idx = history.findIndex(h => h.petName === data.petName);
                if (idx !== -1) history[idx] = JSON.parse(JSON.stringify(data));
                else if (data.petName) history.push(JSON.parse(JSON.stringify(data)));

                renderResults(kcalDay);
                return true;
            } catch (err) {
                console.error(err);
                alert("Error en c&aacute;lculo: " + err.message);
                return false;
            }
        }

        /* ============================================
           7. RENDERING RESULTS
           ============================================ */
        /* --- 7. RENDERING RESULTS --- */
        function renderResults(grams) {
            const headerArea = document.getElementById('resultHeaderArea');
            const list = document.getElementById('resultsList');

            // Reset Scrolls
            window.scrollTo(0, 0);
            const stepRes = document.getElementById('stepResult');
            if (stepRes) stepRes.scrollTop = 0;

            // Personalize Title
            const resTitle = document.getElementById('resTitle');
            const resSub = document.getElementById('resSub');
            if (resTitle && resSub) {
                resTitle.textContent = `¡Hola ${data.clientName || 'amigo'}! 👋`;
                resSub.textContent = `La porción diaria de ${data.petName} es:`;
            }

            // Labels Generation
            const petIcon = data.type === 'dog' ? 'icon_dog_minimal_3d.png' : 'icon_cat_minimal_3d.png';
            const petTypeText = data.type === 'dog' ? 'PERRO' : 'GATO';

            let activityLabel = 'Normal';
            if (data.activity === 'low') activityLabel = 'Tranquilo';
            if (data.activity === 'high') activityLabel = 'Muy Activo';

            const condTitle = (COND_DATA[data.condition] || COND_DATA[4]).t;

            const sizeLabels = { 'mini': 'Mini', 'small': 'Peque&ntilde;o', 'medium': 'Mediano', 'large': 'Grande', 'giant': 'Gigante' };
            const sizeLabel = sizeLabels[data.size] || '';

            // Generate HTML Header
            // Generate HTML Header Compact
            let ageText = `${data.ageY} a&ntilde;os`;
            if (data.ageY === 1) ageText = '1 a&ntilde;o';
            if (data.ageY === 0 && data.ageM > 0) ageText = `${data.ageM} meses`;
            if (data.ageY > 0 && data.ageM > 0) ageText = `${data.ageY}a ${data.ageM}m`;

            headerArea.innerHTML = `
            <div style="background: linear-gradient(90deg, #1e1e1e, #181818); border: 1px solid #333; border-left: 6px solid var(--gold); border-radius: 8px; padding: 12px 15px; margin-bottom: 20px; width: 100%; box-sizing: border-box; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                
                <!-- ROW 1: Identity -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${petIcon}" width="28" style="mix-blend-mode: lighten; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));">
                        <div style="font-size:18px; font-weight:900; color:#fff; letter-spacing:-0.5px; text-transform:uppercase;">${data.petName}</div>
                    </div>
                    <div style="background:var(--gold); color:#111; font-size:10px; font-weight:800; padding:4px 10px; border-radius:4px; letter-spacing:1px; box-shadow: 0 2px 10px rgba(255, 215, 0, 0.2);">${petTypeText}</div>
                </div>

                <div style="font-size:9px; color:#aaa; margin-bottom:12px; margin-top:-8px; font-style:italic; text-align:right;">
                    <span style="border-bottom:1px dashed #666; cursor:pointer;">Click en los datos para editar</span>
                </div>

                <!-- ROW 2: Compact Stats -->
                <!-- ROW 2: Compact Stats -->
                <div class="results-summary-grid">
                    
                    ${data.type === 'dog' ? `
                    <div class="badge-edit" onclick="goToStep('step2_Size')" style="display:flex; flex-direction:column;">
                        <span style="font-size:9px; color:#666; font-weight:700; letter-spacing:0.5px;">TAMA&Ntilde;O</span>
                        <span style="font-size:12px; color:#ddd; font-weight:600;">${sizeLabel}</span>
                    </div>` : ''}

                    <div class="badge-edit" onclick="goToStep('step3_Phys')" style="display:flex; flex-direction:column;">
                        <span style="font-size:9px; color:#666; font-weight:700; letter-spacing:0.5px;">PESO</span>
                        <span style="font-size:12px; color:#ddd; font-weight:600;">${data.weight} kg</span>
                    </div>

                    <div class="badge-edit" onclick="goToStep('step3_Phys')" style="display:flex; flex-direction:column;">
                        <span style="font-size:9px; color:#666; font-weight:700; letter-spacing:0.5px;">EDAD</span>
                        <span style="font-size:12px; color:#ddd; font-weight:600;">${ageText}</span>
                    </div>

                    ${data.type === 'dog' ? `
                    <div class="badge-edit" onclick="goToStep('step4_Life')" style="display:flex; flex-direction:column;">
                        <span style="font-size:9px; color:#666; font-weight:700; letter-spacing:0.5px;">ACTIVIDAD</span>
                        <span style="font-size:12px; color:#ddd; font-weight:600;">${activityLabel}</span>
                    </div>` : ''}

                    <div class="badge-edit" onclick="goToStep('step5_Cond')" style="display:flex; flex-direction:column;">
                        <span style="font-size:9px; color:#666; font-weight:700; letter-spacing:0.5px;">CONDICIÓN</span>
                        <span style="font-size:12px; font-weight:700; color:${data.condition === 4 ? '#81C784' : '#FFD54F'};">${condTitle}</span>
                    </div>

                    <div class="badge-edit" onclick="goToStep('step4_Life')" style="display:flex; flex-direction:column;">
                        <span style="font-size:9px; color:#666; font-weight:700; letter-spacing:0.5px;">ESTADO</span>
                        <span style="font-size:12px; color:#ddd; font-weight:600;">${data.neutered ? 'Esterilizado' : 'Intacto'}</span>
                    </div>
                    
                </div>
            </div>`;

            // Note: Inline styles for badges replaced with class 'badge-edit' for cleaner HTML
            // (You should add .badge-edit to CSS if not present, but for now I'll inject style block dynamically or just use inline if preferred. 
            // To keep "NO LOGIC CHANGE" strictness, I should keep the HTML structure similar or better. 
            // I will simplify the badge HTML a&ntilde;ove for readability).

            // Render Product Cards
            list.innerHTML = '';
            list.className = 'results-stack';
            const products = PRODUCTS_DB[data.type] || [];


            // Product descriptions from official website
            const PRODUCT_DESCRIPTIONS = {
                'red': 'Pollo enriquecido con algas pardas. Potencia el sistema inmune, favorece la digesti&oacute;n y mantiene la piel radiante.',
                'green': 'Res de alta calidad para m&aacute;xima energ&iacute;a. F&oacute;rmula balanceada que ayuda a mantener el peso ideal sin sacrificar vitalidad.',
                'orange': 'Salm&oacute;n y Trucha ricos en Omega-3. Sin granos. Protege articulaciones, coraz&oacute;n y cerebro. Perfecta para est&oacute;magos sensibles.',
                'blue': 'Alta en Salm&oacute;n y Pescado Blanco. Baja en carbohidratos y rica en Omega-3. Protege sus ri&ntilde;ones y garantiza m&aacute;xima hidrataci&oacute;n.'
            };

            products.forEach(prod => {
                // Round portions based on pet type
                const roundTo = data.type === 'cat' ? 10 : 50;
                let dailyGrams = Math.floor((grams / prod.kcal) * 1000 / roundTo) * roundTo;
                const description = PRODUCT_DESCRIPTIONS[prod.id] || prod.ingreds;

                let html = `
                <div class="diet-card-horizontal" style="border-left-color: ${prod.color}" onclick="this.classList.toggle('flipped')">
                    <div class="card-inner">
                        <div class="card-front">
                            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                <div class="dc-left">
                                    <div class="dc-icon"><img src="${prod.iconSrc}" width="24" style="mix-blend-mode:lighten;"></div>
                                    <div class="dc-info">
                                        <div class="dc-title" style="color:${prod.color}">${prod.name}</div>
                                        <div class="dc-desc">${prod.ingreds}</div>
                                    </div>
                                </div>
                                <div class="dc-right">
                                    <div class="dc-grams">${dailyGrams}</div>
                                    <div class="dc-unit">g/día</div>
                                </div>
                            </div>
                            <!-- Interaction Hint -->
                            <div class="card-hint-icon">
                                <span>&#x21bb;</span> Ver detalle
                            </div>
                        </div>
                        <div class="card-back">
                            <div class="card-back-title">${prod.name}</div>
                            <div class="card-back-description">${description}</div>
                        </div>
                    </div>
                </div>`;
                list.innerHTML += html;
            });

            // Advisor Warning
            const advWarn = document.getElementById('advisorWarning');
            advWarn.style.display = (data.condition <= 2 || data.condition >= 6) ? 'block' : 'none';

            // Recommendations
            const infoDiv = document.createElement('div');
            infoDiv.className = 'disclaimer-box';
            infoDiv.style.cssText = "padding:6px 10px; font-size:11px; margin-top:10px; margin-bottom:10px;";
            infoDiv.innerHTML = `
                <div style="margin-bottom:0px;">
                    <strong style="font-size:11px;">RECOMENDACIONES:</strong>
                    <ul style="padding-left:15px; margin-top:2px; line-height:1.3; margin-bottom:0;">
                        <li>La porci&oacute;n mostrada es la <b>dosis total diaria</b>.</li>
                        <li>Puedes dividirla en <b>1 a 3 raciones</b> al d&iacute;a.</li>
                        <li>Puedes mezclar las recetas sin exceder la cantidad total.</li>
                    </ul>
                </div>`;
            list.appendChild(infoDiv);

            renderPetSwitcher(list.parentNode);
        }

        function renderPetSwitcher(container) {
            const existing = document.getElementById('petSwitcherSection');
            if (existing) existing.remove();
            if (history.length === 0) return;

            const wrapper = document.createElement('div');
            wrapper.id = 'petSwitcherSection';
            wrapper.innerHTML = `
                <div style="margin-top:30px; border-top:1px solid #333; padding-top:20px;">
                    <div style="font-size:12px; color:#666; text-transform:uppercase; letter-spacing:1px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                        <span>Mascotas Guardadas</span>
                        <span style="font-size:10px; background:#333; padding:2px 6px; border-radius:10px;">${history.length}</span>
                    </div>
                    <div class="pet-switcher-grid"></div>
                </div>`;
            container.appendChild(wrapper);

            const grid = wrapper.querySelector('.pet-switcher-grid');
            history.forEach((pet, idx) => {
                const isActive = pet.petName === data.petName;
                const iconSrc = pet.type === 'dog' ? 'icon_dog_minimal_3d.png' : 'icon_cat_minimal_3d.png';
                const el = document.createElement('div');
                el.className = `pet-card-mini ${isActive ? 'active' : ''}`;
                el.onclick = () => loadPet(idx);
                el.innerHTML = `
                    <div class="pcm-icon"><img src="${iconSrc}" width="20" style="mix-blend-mode:lighten;"></div>
                    <div class="pcm-info">
                        <div class="pcm-name">${pet.petName}</div>
                        <div class="pcm-sub">${pet.weight}kg • ${pet.type === 'dog' ? 'Perro' : 'Gato'}</div>
                    </div>`;
                grid.appendChild(el);
            });
        }

        function loadPet(index) {
            if (history[index]) {
                data = JSON.parse(JSON.stringify(history[index]));
                calculate();
                window.scrollTo(0, 0);
            }
        }

        function resetCalculamor() {
            const client = data.clientName;
            localStorage.removeItem(STORAGE_KEY); // Clear persistence
            data = {
                clientName: client, petName: '', type: '', size: '',
                weight: 0, ageY: 0, ageM: 0, activity: '', neutered: null, condition: 4
            };
            currentStep = 1;

            // Clear Inputs
            ['petName', 'petWeight', 'petAgeYear', 'petAgeMonth'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            // Clear Selections
            document.querySelectorAll('.big-option, .size-opt, .compact-opt').forEach(el => el.classList.remove('selected'));

            // Reset Slider
            hasInteractedCond = false;
            document.getElementById('condDisplayBox').style.display = 'none';
            const slider = document.getElementById('bodyCondition');
            if (slider) {
                slider.value = 4; // Reset visual pos
                // We don't remove events in cleanup, just reset state
            }
            updateCondition(4, false); // Visual reset

            updateUI();
        }

        // Initialize
        loadState(); // Restore previous session if exists
        updateUI();

    </script>
</body>

</html>